<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <!-- 视口配置：适配移动端，初始缩放比例1.0 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>成绩趋势分析</title>
    <!-- 引入Tailwind CSS CDN，用于快速样式开发 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入Chart.js CDN，用于绘制成绩趋势图表 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <!-- 引入Font Awesome图标库，用于界面图标展示 -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        // 配置Tailwind CSS自定义主题
        tailwind.config = {
          theme: {
            // 扩展自定义颜色变量，便于统一样式管理
            extend: {
              colors: {
                primary: '#3b82f6',    // 主色调：蓝色
                secondary: '#10b981',  // 辅助色：绿色
                neutral: {             // 中性色系列
                  100: '#f3f4f6',
                  200: '#e5e7eb',
                  300: '#d1d5db',
                  700: '#374151',
                  800: '#1f2937',
                  900: '#111827'
                }
              },
            },
          }
        }
    </script>
    <style type="text/tailwindcss">
        /* 自定义Tailwind工具类 */
        @layer utilities {
          /* 内容可见性自动优化：提升页面渲染性能 */
          .content-auto {
            content-visibility: auto;
          }
          /* 自定义过渡动画：统一交互效果 */
          .transition-custom {
            transition: all 0.3s ease;
          }
        }
    </style>
</head>
<!-- 页面主体：浅灰色背景，最小高度占满屏幕 -->
<body class="bg-neutral-100 min-h-screen">
<!-- 导航栏组件：白色背景，阴影效果 -->
<nav class="bg-white shadow-md">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-16">
            <!-- 左侧logo和导航链接 -->
            <div class="flex items-center">
                <a href="/student-assignment.html" class="flex-shrink-0 flex items-center">
                    <i class="fa fa-graduation-cap text-primary text-2xl mr-2"></i>
                    <span class="font-bold text-xl text-neutral-800">教育平台</span>
                </a>
                <!-- 仅在sm及以上屏幕显示的导航链接 -->
                <div class="hidden sm:ml-6 sm:flex sm:space-x-8">
                    <a href="/student-assignment.html"
                       class="border-transparent text-neutral-500 hover:border-neutral-300 hover:text-neutral-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                        作业列表
                    </a>
                    <a href="/student-assignment.html#class"
                       class="border-transparent text-neutral-500 hover:border-neutral-300 hover:text-neutral-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                        我的班级
                    </a>
                    <a href="/submissions"
                       class="border-transparent text-neutral-500 hover:border-neutral-300 hover:text-neutral-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                        我的提交
                    </a>
                    <a href="/grade-trend.html"
                       class="border-primary text-primary inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                        成绩趋势
                    </a>
                </div>
            </div>
            <!-- 右侧用户信息和退出按钮 -->
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <button id="logoutBtn"
                            class="relative inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-red-500 hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                        <i class="fa fa-sign-out mr-2"></i>退出登录
                    </button>
                </div>
                <div class="ml-3 relative">
                    <div class="flex items-center max-w-xs rounded-full text-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                        <span class="text-neutral-700 mr-2" id="usernameDisplay">学生名称</span>
                        <i class="fa fa-user-circle text-2xl text-neutral-600"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</nav>

<!-- 主内容区：最大宽度限制，水平居中，内边距 -->
<main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- 页面标题区域 -->
    <div class="mb-8">
        <h1 class="text-2xl font-bold text-neutral-800">成绩趋势分析</h1>
        <p class="text-neutral-600 mt-1">查看各班级最近5次作业成绩趋势</p>
    </div>

    <!-- 加载指示器：初始显示，数据加载完成后隐藏 -->
    <div id="loadingIndicator" class="bg-white shadow overflow-hidden sm:rounded-lg p-8 text-center">
        <i class="fa fa-spinner fa-spin text-primary text-2xl mr-2"></i>
        <span class="text-neutral-600">加载成绩数据中...</span>
    </div>

    <!-- 成绩图表容器：初始隐藏，数据加载成功后显示 -->
    <div id="chartsContainer" class="hidden space-y-6">
        <!-- 图表将通过JavaScript动态生成 -->
    </div>

    <!-- 无数据提示：初始隐藏，无数据时显示 -->
    <div id="noDataMessage" class="hidden bg-white shadow overflow-hidden sm:rounded-lg p-8 text-center">
        <i class="fa fa-info-circle text-neutral-400 text-3xl mb-4"></i>
        <p class="text-neutral-500">暂无成绩数据</p>
        <p class="text-neutral-400 text-sm mt-2">请先提交作业并等待批改</p>
    </div>
</main>

<script>
    // ==================== 全局配置常量 ====================
    // API基础地址：后端服务地址
    const API_BASE_URL = 'http://localhost:5000';
    // 存储Chart.js实例的对象：键为班级ID，值为图表实例，便于后续管理
    const charts = {};

    // ==================== 页面初始化逻辑 ====================
    /**
     * 页面DOM加载完成后执行的初始化操作
     * 1. 验证用户登录状态和权限
     * 2. 显示当前登录用户名
     * 3. 加载成绩趋势数据
     * 4. 绑定退出登录事件
     */
    document.addEventListener('DOMContentLoaded', () => {
      // 从本地存储获取登录凭证和用户信息
      const token = localStorage.getItem('token');
      const user = JSON.parse(localStorage.getItem('user'));

      // 登录状态验证：无token/无用户信息/非学生角色，跳转到登录页
      if (!token || !user || user.role !== 'student') {
        window.location.href = '../login.html';
        return;
      }

      // 显示当前登录学生的用户名
      document.getElementById('usernameDisplay').textContent = user.username;

      // 加载成绩趋势数据
      loadGradeTrend();

      // 绑定退出登录按钮点击事件
      document.getElementById('logoutBtn').addEventListener('click', logout);
    });

    // ==================== 成绩趋势核心功能 ====================
    /**
     * 加载成绩趋势数据
     * 1. 发起API请求获取学生各班级成绩趋势
     * 2. 根据返回结果展示不同状态（加载中/图表/无数据）
     * 3. 处理请求异常并展示错误信息
     */
    async function loadGradeTrend() {
      // 获取页面元素引用
      const token = localStorage.getItem('token');
      const loadingIndicator = document.getElementById('loadingIndicator');
      const chartsContainer = document.getElementById('chartsContainer');
      const noDataMessage = document.getElementById('noDataMessage');

      try {
        // 发起GET请求获取成绩趋势数据
        const response = await fetch(`${API_BASE_URL}/api/student/grades/trend`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,  // 携带JWT令牌认证
            'Content-Type': 'application/json'
          }
        });

        // 非2xx状态码视为请求失败
        if (!response.ok) {
          throw new Error('获取成绩趋势失败');
        }

        // 解析响应JSON数据
        const result = await response.json();

        // 无数据情况：隐藏加载指示器，显示无数据提示
        if (!result.success || !result.data || result.data.length === 0) {
          loadingIndicator.classList.add('hidden');
          noDataMessage.classList.remove('hidden');
          return;
        }

        // 数据加载成功：切换显示状态
        loadingIndicator.classList.add('hidden');
        chartsContainer.classList.remove('hidden');
        noDataMessage.classList.add('hidden');

        // 清空图表容器，为每个班级渲染成绩图表
        chartsContainer.innerHTML = '';
        for (const classData of result.data) {
          await renderClassChart(classData);
        }

      } catch (error) {
        // 捕获并处理所有异常，展示错误信息
        console.error('加载成绩趋势失败:', error);
        loadingIndicator.innerHTML = `
          <div class="text-center">
            <i class="fa fa-exclamation-circle text-red-500 text-2xl mr-2"></i>
            <span class="text-red-500">加载失败: ${error.message}</span>
          </div>
        `;
      }
    }

    /**
     * 渲染单个班级的成绩趋势图表
     * @param {Object} classData - 班级成绩数据对象
     * @property {number} class_id - 班级ID
     * @property {string} class_name - 班级名称
     * @property {string} class_code - 班级代码
     * @property {Array} submissions - 提交记录数组
     */
    async function renderClassChart(classData) {
      const chartsContainer = document.getElementById('chartsContainer');
      const classId = classData.class_id;
      const className = classData.class_name;
      const submissions = classData.submissions;

      // 提取图表所需数据
      // 横坐标标签：提交日期（月/日格式）
      const labels = submissions.map(s => {
        const date = new Date(s.submitted_at);
        return date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' });
      });
      // 成绩数据：纵轴数值
      const grades = submissions.map(s => s.grade);
      // 作业标题：用于tooltip提示
      const assignmentTitles = submissions.map(s => s.assignment_title);

      // 创建图表卡片容器
      const chartCard = document.createElement('div');
      chartCard.className = 'bg-white shadow overflow-hidden sm:rounded-lg p-6';
      chartCard.id = `chart-card-${classId}`;
      // 将提交数据存储在dataset中，供后续AI分析使用
      chartCard.dataset.submissions = JSON.stringify(submissions);

      // 图表卡片HTML结构
      chartCard.innerHTML = `
        <div class="mb-4">
          <h3 class="text-lg font-medium text-neutral-900">${escapeHtml(className)}</h3>
          <p class="text-sm text-neutral-500">班级代码: ${escapeHtml(classData.class_code)}</p>
        </div>
        <div class="mb-4" style="position: relative; height: 300px;">
          <canvas id="chart-${classId}"></canvas>
        </div>
        <div class="mt-4 p-4 bg-neutral-50 rounded-lg">
          <div class="flex items-center justify-between mb-2">
            <span class="text-sm font-medium text-neutral-700">AI趋势分析：</span>
            <button id="analyzeBtn-${classId}" onclick="analyzeTrend(${classId}, '${escapeHtml(className)}', this)"
                    class="inline-flex items-center px-3 py-1.5 border border-transparent text-sm font-medium rounded-md text-white bg-primary hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
              <i class="fa fa-line-chart mr-1"></i>分析趋势
            </button>
          </div>
          <div id="analysis-${classId}" class="text-sm text-neutral-500 mt-2 min-h-[40px]">
            <p class="text-neutral-400 italic">点击"分析趋势"按钮获取AI分析结果</p>
          </div>
        </div>
      `;

      // 将图表卡片添加到容器中
      chartsContainer.appendChild(chartCard);

      // 创建Chart.js折线图
      const ctx = document.getElementById(`chart-${classId}`).getContext('2d');
      const chart = new Chart(ctx, {
        type: 'line',  // 图表类型：折线图
        data: {
          labels: labels,  // 横坐标标签
          datasets: [{
            label: '成绩',
            data: grades,   // 成绩数据
            borderColor: 'rgb(59, 130, 246)',  // 线条颜色
            backgroundColor: 'rgba(59, 130, 246, 0.1)',  // 填充颜色
            tension: 0.4,   // 线条平滑度
            fill: true,     // 是否填充线下区域
            pointRadius: 6, // 数据点基础半径
            pointHoverRadius: 8,  // 鼠标悬停时数据点半径
            pointBackgroundColor: 'rgb(59, 130, 246)',  // 数据点填充色
            pointBorderColor: '#fff',  // 数据点边框色
            pointBorderWidth: 2        // 数据点边框宽度
          }]
        },
        options: {
          responsive: true,  // 响应式布局
          maintainAspectRatio: false,  // 不保持宽高比，使用固定高度
          plugins: {
            legend: {
              display: false  // 隐藏图例
            },
            tooltip: {
              // 自定义tooltip提示内容
              callbacks: {
                label: function(context) {
                  const index = context.dataIndex;
                  return `${assignmentTitles[index]}: ${context.parsed.y}分`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: false,  // 纵轴不从0开始
              // 纵轴最小值：成绩最小值减10（但不小于0）
              min: Math.max(0, Math.min(...grades) - 10),
              // 纵轴最大值：成绩最大值加10（但不大于100）
              max: Math.min(100, Math.max(...grades) + 10),
              // 纵轴刻度标签自定义：添加"分"单位
              ticks: {
                callback: function(value) {
                  return value + '分';
                }
              }
            }
          }
        }
      });

      // 将图表实例存储到全局对象，便于后续管理
      charts[classId] = chart;
    }

    /**
     * AI趋势分析功能
     * @param {number} classId - 班级ID
     * @param {string} className - 班级名称
     * @param {HTMLElement} buttonElement - 触发分析的按钮元素
     */
    async function analyzeTrend(classId, className, buttonElement) {
      // 获取必要的DOM元素
      const token = localStorage.getItem('token');
      const analysisDiv = document.getElementById(`analysis-${classId}`);
      const analyzeButton = buttonElement || document.getElementById(`analyzeBtn-${classId}`);

      // 校验元素是否存在
      if (!analysisDiv) return;

      // 获取存储的成绩数据
      const chartCard = document.getElementById(`chart-card-${classId}`);
      if (!chartCard) return;

      // 显示分析中状态
      analysisDiv.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>正在分析中，请稍候...';
      if (analyzeButton) {
        analyzeButton.disabled = true;
        analyzeButton.innerHTML = '<i class="fa fa-spinner fa-spin mr-1"></i>分析中...';
      }

      try {
        // 从dataset中获取存储的提交数据
        const storedSubmissions = chartCard.dataset.submissions;
        let gradeData = [];

        if (storedSubmissions) {
          gradeData = JSON.parse(storedSubmissions);
        } else {
          // 若本地无存储数据，重新从API获取
          const response = await fetch(`${API_BASE_URL}/api/student/grades/trend`, {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            }
          });

          if (response.ok) {
            const result = await response.json();
            const classData = result.data.find(c => c.class_id === classId);
            if (classData) {
              gradeData = classData.submissions;
              // 存储数据到dataset
              chartCard.dataset.submissions = JSON.stringify(classData.submissions);
            }
          }
        }

        // 无成绩数据处理
        if (gradeData.length === 0) {
          analysisDiv.innerHTML = '<p class="text-neutral-500">暂无成绩数据</p>';
          if (analyzeButton) {
            analyzeButton.disabled = false;
            analyzeButton.innerHTML = '<i class="fa fa-line-chart mr-1"></i>分析趋势';
          }
          return;
        }

        // 调用AI分析API
        const analyzeResponse = await fetch(`${API_BASE_URL}/api/student/grades/trend/analyze`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            class_name: className,
            grade_data: gradeData
          })
        });

        // 解析分析结果
        const analyzeResult = await analyzeResponse.json();

        if (analyzeResult.success) {
          // 分析成功：展示AI分析结果
          analysisDiv.innerHTML = `<p class="text-neutral-700 leading-relaxed">${escapeHtml(analyzeResult.analysis)}</p>`;
          // 更新按钮文本为"重新分析"
          if (analyzeButton) {
            analyzeButton.innerHTML = '<i class="fa fa-refresh mr-1"></i>重新分析';
          }
        } else {
          // 分析失败：展示错误信息
          analysisDiv.innerHTML = `<p class="text-red-500">${escapeHtml(analyzeResult.message || '分析失败')}</p>`;
          if (analyzeButton) {
            analyzeButton.innerHTML = '<i class="fa fa-line-chart mr-1"></i>分析趋势';
          }
        }
      } catch (error) {
        // 捕获网络/代码异常
        console.error('AI分析失败:', error);
        analysisDiv.innerHTML = `<p class="text-red-500">分析失败: ${error.message}</p>`;
        if (analyzeButton) {
          analyzeButton.innerHTML = '<i class="fa fa-line-chart mr-1"></i>分析趋势';
        }
      } finally {
        // 无论成功失败，恢复按钮可用状态
        if (analyzeButton) {
          analyzeButton.disabled = false;
        }
      }
    }

    // ==================== 通用工具函数 ====================
    /**
     * 格式化日期时间字符串
     * @param {string} dateString - 原始日期字符串
     * @returns {string} 格式化后的本地日期时间字符串
     */
    function formatDateTime(dateString) {
  if (!dateString) return '';

  // 解析时直接当北京时间处理
  const date = new Date(dateString + '+08:00');

  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  const hours = String(date.getHours()).padStart(2, '0');
  const minutes = String(date.getMinutes()).padStart(2, '0');
  const seconds = String(date.getSeconds()).padStart(2, '0');

  return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
}

    /**
     * HTML转义函数：防止XSS攻击
     * @param {string} unsafe - 未转义的原始字符串
     * @returns {string} 转义后的安全字符串
     */
    function escapeHtml(unsafe) {
      if (!unsafe) return '';
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // ==================== 用户操作功能 ====================
    /**
     * 退出登录功能
     * 1. 弹出确认对话框
     * 2. 清除本地存储的登录凭证
     * 3. 跳转到首页
     */
    function logout() {
      if (confirm('确定要退出登录吗？')) {
        localStorage.removeItem('token');    // 清除JWT令牌
        localStorage.removeItem('user');     // 清除用户信息
        window.location.href = '/';         // 跳转首页
      }
    }
</script>
</body>
</html>